name: Deploy to VPS

# Runs automatically on every push to main.
# Secrets are injected over SSH — nothing sensitive ever touches the repo.

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger from GitHub Actions tab

jobs:
  deploy:
    name: Deploy OpenClaw TradeDesk
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_USER_ID: ${{ secrets.TELEGRAM_USER_ID }}
          # Optional — leave unset to keep the default gateway token from openclaw.json.example
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # Pass env vars into the remote shell session
          envs: ANTHROPIC_API_KEY,TELEGRAM_BOT_TOKEN,TELEGRAM_USER_ID,OPENCLAW_GATEWAY_TOKEN
          timeout: 300s
          script: |
            set -e

            WORKSPACE="$HOME/.openclaw/workspace"
            CONFIG="$HOME/.openclaw/openclaw.json"

            # ── 0. Bootstrap PATH (nvm / local bins) ────────────────────────────────
            # OpenClaw is Node.js-based and may be installed via nvm or npm global.
            # SSH sessions don't load .bashrc, so we source nvm manually.
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH="$HOME/.local/bin:$HOME/.npm/bin:/usr/local/bin:$PATH"

            # ── 1. Clone or pull the workspace ──────────────────────────────────────
            if [ -d "$WORKSPACE/.git" ]; then
              echo "==> Pulling latest changes into workspace..."
              git -C "$WORKSPACE" pull origin main
            else
              echo "==> Cloning repo into $WORKSPACE..."
              # Back up any existing (non-git) workspace so nothing is silently lost
              if [ -d "$WORKSPACE" ]; then
                BACKUP="${WORKSPACE}-backup-$(date +%Y%m%d%H%M%S)"
                echo "    Existing workspace moved to: $BACKUP"
                mv "$WORKSPACE" "$BACKUP"
              fi
              mkdir -p "$HOME/.openclaw"
              git clone https://github.com/Sensini7/OpenClaw-TradeDesk.git "$WORKSPACE"
            fi

            # ── 2. Inject secrets into ~/.openclaw/openclaw.json ────────────────────
            # Done BEFORE installing OpenClaw so the installer finds a pre-existing
            # config and skips the interactive onboarding wizard (no TTY in CI).
            echo "==> Writing $CONFIG from template..."
            mkdir -p "$HOME/.openclaw"
            cp "$WORKSPACE/openclaw.json.example" "$CONFIG"

            sed -i "s|YOUR_KEY_HERE|${ANTHROPIC_API_KEY}|g"        "$CONFIG"
            sed -i "s|YOUR_BOT_TOKEN_HERE|${TELEGRAM_BOT_TOKEN}|g"  "$CONFIG"
            sed -i "s|YOUR_TELEGRAM_USER_ID|${TELEGRAM_USER_ID}|g"  "$CONFIG"

            # Replace gateway token only if the secret is set (otherwise keep default)
            if [ -n "${OPENCLAW_GATEWAY_TOKEN}" ]; then
              sed -i "s|4bbaf7385f68a2d6914bdf661a52403ca213d2fd018ecbab|${OPENCLAW_GATEWAY_TOKEN}|g" "$CONFIG"
            fi

            # Fix workspace paths in config if running as a non-root user
            if [ "$HOME" != "/root" ]; then
              sed -i "s|/root/.openclaw/workspace|$HOME/.openclaw/workspace|g" "$CONFIG"
            fi

            echo "==> Secrets injected into openclaw.json."

            # ── 3. Install OpenClaw if not present ──────────────────────────────────
            # CI=1 tells the installer to run non-interactively.
            # The pre-written openclaw.json above means the installer has no reason
            # to prompt for credentials even if CI detection is incomplete.
            if ! command -v openclaw &>/dev/null; then
              echo "==> OpenClaw not found — installing..."
              CI=1 curl -fsSL https://openclaw.ai/install.sh | bash

              # Re-source nvm and PATH in case the installer added new entries
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              export PATH="$HOME/.local/bin:$HOME/.npm/bin:/usr/local/bin:$PATH"

              if ! command -v openclaw &>/dev/null; then
                echo "ERROR: OpenClaw installation failed — binary not found after install."
                exit 1
              fi
              echo "==> OpenClaw installed: $(openclaw --version 2>/dev/null || echo 'version unknown')"
            else
              echo "==> OpenClaw already installed: $(openclaw --version 2>/dev/null || echo 'version unknown')"
            fi

            # ── 4. Create intel/ symlinks (idempotent) ──────────────────────────────
            # Each agent workspace must have intel/ symlinked so agents can
            # read/write pipeline files without stepping outside their workspace.
            echo "==> Creating intel symlinks..."
            for agent in scout oracle trigger sentinel herald; do
              ln -sf "$WORKSPACE/intel" "$WORKSPACE/agents/$agent/intel"
              echo "    agents/$agent/intel -> $WORKSPACE/intel"
            done

            # ── 5. Start/restart OpenClaw gateway ───────────────────────────────────
            # On first deploy the gateway may not be registered as a systemd daemon yet.
            # We try restart first (fast path for subsequent deploys), then fall back
            # to install-daemon which registers the service and starts it.
            echo "==> Starting OpenClaw gateway..."
            if openclaw gateway restart 2>/dev/null; then
              echo "    Gateway restarted."
            else
              echo "    Gateway not registered yet — running first-time daemon setup..."
              CI=1 openclaw onboard --install-daemon 2>/dev/null || \
                openclaw gateway install-daemon 2>/dev/null || \
                openclaw gateway start 2>/dev/null || {
                  echo "ERROR: Could not start the OpenClaw gateway."
                  echo "SSH into the server and run: openclaw onboard --install-daemon"
                  exit 1
                }
            fi

            # ── 6. Health checks ────────────────────────────────────────────────────
            echo "==> Waiting for gateway to be ready..."
            sleep 5

            echo "--- Gateway status ---"
            openclaw gateway status

            echo "--- Agent list ---"
            openclaw agents list

            echo ""
            echo "Deployment complete."
