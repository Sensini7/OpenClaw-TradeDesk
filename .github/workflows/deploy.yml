name: Deploy to VPS

# Runs automatically on every push to main.
# Secrets are injected over SSH — nothing sensitive ever touches the repo.

on:
  push:
    branches:
      - main
      - claude/genericize-readme-BrYAW  # temp: remove after merging to main
  workflow_dispatch: # Allow manual trigger from GitHub Actions tab

jobs:
  deploy:
    name: Deploy OpenClaw TradeDesk
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_USER_ID: ${{ secrets.TELEGRAM_USER_ID }}
          # Optional — leave unset to keep the default gateway token from openclaw.json.example
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # Pass env vars into the remote shell session
          envs: ANTHROPIC_API_KEY,TELEGRAM_BOT_TOKEN,TELEGRAM_USER_ID,OPENCLAW_GATEWAY_TOKEN
          timeout: 300s
          script: |
            set -e

            WORKSPACE="$HOME/.openclaw/workspace"
            CONFIG="$HOME/.openclaw/openclaw.json"

            # ── 0. Bootstrap PATH (nvm / local bins) ────────────────────────────────
            # OpenClaw is Node.js-based and may be installed via nvm or npm global.
            # SSH sessions don't load .bashrc, so we source nvm manually.
            # openclaw >=2026.x requires Node >=22 — install it if missing (idempotent).
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install 22 2>/dev/null && nvm alias default 22 2>/dev/null || true
            export PATH="$HOME/.local/bin:$HOME/.npm/bin:/usr/local/bin:$PATH"

            # ── 1. Clone or pull the workspace ──────────────────────────────────────
            if [ -d "$WORKSPACE/.git" ]; then
              echo "==> Pulling latest changes into workspace..."
              git -C "$WORKSPACE" pull origin main
            else
              echo "==> Cloning repo into $WORKSPACE..."
              # Back up any existing (non-git) workspace so nothing is silently lost
              if [ -d "$WORKSPACE" ]; then
                BACKUP="${WORKSPACE}-backup-$(date +%Y%m%d%H%M%S)"
                echo "    Existing workspace moved to: $BACKUP"
                mv "$WORKSPACE" "$BACKUP"
              fi
              mkdir -p "$HOME/.openclaw"
              git clone https://github.com/Sensini7/OpenClaw-TradeDesk.git "$WORKSPACE"
            fi

            # ── 2. Inject secrets into openclaw config files ─────────────────────────
            # Done BEFORE installing OpenClaw so the installer finds a pre-existing
            # config and skips the interactive onboarding wizard (no TTY in CI).
            #
            # IMPORTANT: auth.profiles in openclaw.json is METADATA ONLY (provider +
            # mode). The actual API key must be written to auth-profiles.json, which
            # openclaw reads separately. Do NOT put the API key inside openclaw.json.
            echo "==> Writing $CONFIG from template..."
            mkdir -p "$HOME/.openclaw"
            cp "$WORKSPACE/openclaw.json.example" "$CONFIG"

            sed -i "s|YOUR_BOT_TOKEN_HERE|${TELEGRAM_BOT_TOKEN}|g"  "$CONFIG"
            sed -i "s|YOUR_TELEGRAM_USER_ID|${TELEGRAM_USER_ID}|g"  "$CONFIG"

            # Replace gateway token only if the secret is set (otherwise keep default)
            if [ -n "${OPENCLAW_GATEWAY_TOKEN}" ]; then
              sed -i "s|4bbaf7385f68a2d6914bdf661a52403ca213d2fd018ecbab|${OPENCLAW_GATEWAY_TOKEN}|g" "$CONFIG"
            fi

            # Fix workspace paths in config if running as a non-root user
            if [ "$HOME" != "/root" ]; then
              sed -i "s|/root/.openclaw/workspace|$HOME/.openclaw/workspace|g" "$CONFIG"
            fi

            # Write the actual API key to auth-profiles.json (separate from openclaw.json)
            # openclaw reads this file to resolve the "default" api_key profile.
            printf '{\n  "default": {\n    "apiKey": "%s"\n  }\n}\n' "${ANTHROPIC_API_KEY}" > "$HOME/.openclaw/auth-profiles.json"

            echo "==> Config and auth-profiles.json written."

            # ── 3. Install OpenClaw if not present ──────────────────────────────────
            # CI=1 tells the installer to run non-interactively.
            # The pre-written openclaw.json above means the installer skips the
            # interactive onboarding wizard.
            #
            # NOTE: The install.sh "Finalizing setup" step runs `openclaw` internally
            # and will exit 1 in no-TTY CI environments (/dev/tty unavailable).
            # The npm package itself is fully installed before that step — so we run
            # the installer in a subshell, suppress its exit code, then verify the
            # binary exists independently.
            if ! command -v openclaw &>/dev/null; then
              echo "==> OpenClaw not found — installing..."
              ( curl -fsSL https://openclaw.ai/install.sh | CI=1 bash ) 2>&1 || true

              # Re-source nvm so the newly installed bin/ is on PATH
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              nvm use 22 2>/dev/null || true
              export PATH="$HOME/.local/bin:$HOME/.npm/bin:/usr/local/bin:$PATH"

              if ! command -v openclaw &>/dev/null; then
                echo "ERROR: OpenClaw installation failed — binary not found after install."
                exit 1
              fi
              echo "==> OpenClaw installed: $(openclaw --version 2>/dev/null || echo 'version unknown')"
            else
              echo "==> OpenClaw already installed: $(openclaw --version 2>/dev/null || echo 'version unknown')"
            fi

            # ── 4. Create intel/ symlinks (idempotent) ──────────────────────────────
            # Each agent workspace must have intel/ symlinked so agents can
            # read/write pipeline files without stepping outside their workspace.
            echo "==> Creating intel symlinks..."
            for agent in scout oracle trigger sentinel herald; do
              ln -sf "$WORKSPACE/intel" "$WORKSPACE/agents/$agent/intel"
              echo "    agents/$agent/intel -> $WORKSPACE/intel"
            done

            # ── 4.5. Migrate config to current schema ───────────────────────────────
            # doctor --fix auto-migrates stale fields (e.g. streaming boolean → enum,
            # missing telegram.enabled). Must run after openclaw is installed.
            echo "==> Running openclaw doctor --fix to migrate config..."
            openclaw doctor --fix 2>&1 || true

            # ── 5. Start/restart OpenClaw gateway ───────────────────────────────────
            # 'openclaw gateway restart' exits 0 even when the service is disabled
            # ("Gateway service disabled.") so we cannot rely on its exit code.
            # Instead: always ensure the daemon is installed first (idempotent),
            # then restart. The install step is a no-op when already installed.
            echo "==> Starting OpenClaw gateway..."
            openclaw gateway install 2>/dev/null || \
              openclaw gateway install-daemon 2>/dev/null || true

            if openclaw gateway restart 2>/dev/null; then
              echo "    Gateway restarted."
            else
              openclaw gateway start 2>/dev/null || {
                echo "ERROR: Could not start the OpenClaw gateway."
                echo "SSH into the server and run: openclaw gateway install && openclaw gateway start"
                exit 1
              }
            fi

            # ── 6. Health checks ────────────────────────────────────────────────────
            echo "==> Waiting for gateway to be ready..."
            sleep 5

            echo "--- Gateway status ---"
            openclaw gateway status

            echo "--- Agent list ---"
            openclaw agents list

            echo ""
            echo "Deployment complete."
